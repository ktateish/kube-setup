# DO NOT EDIT -- Auto generated by ansible

{% for c in k8s_ca_clients + k8s_ca_users %}
client_KUBECONFIGS += {{ c.name }}.kubeconfig {{ c.name }}.kubeconfig.pub
{% endfor %}

all: token.csv bootstrap.kubeconfig etcd_token $(client_KUBECONFIGS)

bootstrap_token: etcd_token
	( umask 077 \
	&& head -c 16 /dev/urandom | od -An -t x | tr -d ' ' > $@.tmp \
	&& mv -f $@.tmp $@ )

token.csv: bootstrap_token
	( umask 077 \
	&& printf '%s,kubelet-bootstrap,10001,"system:kubelet-bootstrap"\n' $$(cat $<) > $@.tmp \
	&& mv -f $@.tmp $@ )

etcd_token: ../ca/ca.pem
	( umask 077 \
	&& head -c 16 /dev/urandom | od -An -t x | tr -d ' ' > $@.tmp \
	&& mv -f $@.tmp $@ )

bootstrap.kubeconfig: bootstrap_token ../ca/ca.pem
	( kubectl config set-cluster {{ k8s_cluster_name }} \
		--certificate-authority=../ca/ca.pem \
		--embed-certs=true \
		--server=https://{{ k8s_cluster_name }}.{{ k8s_domain }}:6443 \
		--kubeconfig=$@.tmp \
	&& kubectl config set-credentials kubelet-bootstrap \
		--token=$$(cat bootstrap_token) \
		--kubeconfig=$@.tmp \
	&& kubectl config set-context default \
		--cluster={{ k8s_cluster_name }} \
		--user=kubelet-bootstrap \
		--kubeconfig=$@.tmp \
	&& kubectl config use-context default --kubeconfig=$@.tmp \
	&& mv $@.tmp $@ )

%.kubeconfig:  ../ca/ca.pem ../ca/%-key.pem ../ca/%.pem
	( kubectl config set-cluster {{ k8s_cluster_name }}.{{k8s_domain }} \
		--certificate-authority=../ca/ca.pem \
		--embed-certs=true \
		--server=https://{{ k8s_cluster_name }}.{{ k8s_domain }}:6443 \
		--kubeconfig=$@.tmp \
	&& kubectl config set-credentials $*@{{ k8s_cluster_name }}.{{ k8s_domain }} \
		--client-certificate=../ca/$*.pem \
		--client-key=../ca/$*-key.pem \
		--embed-certs=true \
		--kubeconfig=$@.tmp \
	&& kubectl config set-context $*@{{ k8s_cluster_name}}.{{ k8s_domain }} \
		--cluster={{ k8s_cluster_name }}.{{ k8s_domain }} \
		--user=$*@{{ k8s_cluster_name }}.{{ k8s_domain }} \
		--namespace=$* \
		--kubeconfig=$@.tmp \
	&& kubectl config use-context $*@{{ k8s_cluster_name}}.{{ k8s_domain }} --kubeconfig=$@.tmp \
	&& mv $@.tmp $@ )

%.kubeconfig.pub:  ../ca/ca.pem ../ca/%-key.pem ../ca/%.pem
	( kubectl config set-cluster {{ k8s_public_fqdn }} \
		--certificate-authority=../ca/ca.pem \
		--embed-certs=true \
		--server=https://{{ k8s_public_fqdn }}:{{ k8s_public_port }} \
		--kubeconfig=$@.tmp \
	&& kubectl config set-credentials $*@{{ k8s_public_fqdn }} \
		--client-certificate=../ca/$*.pem \
		--client-key=../ca/$*-key.pem \
		--embed-certs=true \
		--kubeconfig=$@.tmp \
	&& kubectl config set-context $*@{{ k8s_public_fqdn }} \
		--cluster={{ k8s_public_fqdn }} \
		--user=$*@{{ k8s_public_fqdn }} \
		--namespace=$* \
		--kubeconfig=$@.tmp \
	&& kubectl config use-context $*@{{ k8s_public_fqdn }} --kubeconfig=$@.tmp \
	&& mv $@.tmp $@ )
