# DO NOT EDIT -- Auto generated by ansible

CATARGETS = etcd-key.pem etcd.pem
CATARGETS += kubernetes-key.pem kubernetes.pem
{% for c in k8s_ca_targets %}
CATARGETS += {{ c.name }}-key.pem {{ c.name }}.pem
{% endfor %}

all: ca-key.pem ca.pem $(CATARGETS)

clean: clean-pem clean-csr
	@echo "Remove ca-key.pem and ca.pem by your hand if needed"

# CA
ca-key.pem ca.pem: ca-csr.json
	cfssl gencert -initca ca-csr.json | cfssljson -bare ca

etcd-key.pem etcd.csr etcd.pem: etcd-csr.json ca-key.pem
	cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json \
		-profile=kubernetes etcd-csr.json | cfssljson -bare etcd

kubernetes-key.pem kubernetes.csr kubernetes.pem: kubernetes-csr.json ca-key.pem
	cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json \
		-profile=kubernetes kubernetes-csr.json | cfssljson -bare kubernetes

{% for c in k8s_ca_targets %}
{{ c.name }}-key.pem {{ c.name }}.csr {{ c.name }}.pem: {{ c.name }}-csr.json ca-key.pem
	cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json \
		-profile=kubernetes {{ c.name }}-csr.json | cfssljson -bare {{ c.name }}

{% endfor %}

clean-pem:
	rm -f \
{% for c in k8s_ca_clients %}
	rm -f {{ c.name }}-key.pem {{ c.name }}.pem \
{% endfor %}
	etcd-key.pem etcd.pem
	kubernetes-key.pem kubernetes.pem

clean-csr:
	rm -f *.csr
